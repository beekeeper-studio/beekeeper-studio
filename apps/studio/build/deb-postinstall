#! /bin/bash

OLD_FILE=/etc/apt/sources.list.d/beekeeper-studio.list
NEW_FILE=/etc/apt/sources.list.d/beekeeper-studio-app.list
KEY_FILE=/usr/share/keyrings/beekeeper-studio.gpg

available() {
  command -v "$1" &>/dev/null
}

if [ -f $OLD_FILE ]; then
  echo "--> Beekeeper Studio has migrated to a new apt repo, adding it, and removing the old one"
  echo "--> For more information see https://docs.beekeeperstudio.io/installation"
  rm -f $OLD_FILE
  rm -f $OLD_FILE.save
fi

if [ ! -f /usr/bin/beekeeper-studio ]; then
  ln -s /opt/Beekeeper\ Studio/beekeeper-studio /usr/bin/beekeeper-studio
fi

if [ ! -f $NEW_FILE ] || ! grep -iq 'signed-by' $NEW_FILE; then
  echo "deb [signed-by=$KEY_FILE] https://deb.beekeeperstudio.io stable main" > $NEW_FILE
fi

if available apt-key && grep -iq 'beekeeper' <<< "$(apt-key list 2>/dev/null)"; then
  apt-key del 'AD1B460B' &>/dev/null
fi

key_dir=$(dirname $KEY_FILE)
if [ ! -d "$key_dir" ]; then
  mkdir -p -m 755 "$key_dir"
fi

if [ ! -f $KEY_FILE ]; then
  curl -s https://deb.beekeeperstudio.io/beekeeper.key | gpg --dearmor > $KEY_FILE
fi
