name: DEB Package Hardlinks Test

on:
  # Run when master or test branch is updated
  push:
    branches:
      - master
      - test-deb-hardlinks
    paths-ignore:
      - 'apps/sqltools/**'
      - 'docs/**'

  # Allow manual trigger
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-deb-hardlinks:
    name: Test DEB on separate filesystems
    runs-on: ubuntu-22.04

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v1

      - name: Download DEB artifact from build workflow
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: studio-build-non-production.yml
          name: ubuntu-22.04
          path: ./deb-package
          # Wait for the build workflow to complete
          workflow_conclusion: success
          # Use the same commit
          commit: ${{ github.sha }}
          # Search in the last 10 workflow runs
          search_artifacts: true

      - name: List downloaded files
        run: |
          echo "Contents of deb-package directory:"
          ls -lh ./deb-package/

      - name: Find DEB file
        id: find_deb
        run: |
          DEB_FILE=$(find ./deb-package -name "*.deb" | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "ERROR: No .deb file found in artifact"
            exit 1
          fi
          echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT
          echo "Found DEB file: $DEB_FILE"

      - name: Make test script executable
        run: chmod +x ./bin/test-deb-hardlinks.sh

      - name: Run hardlinks test
        run: |
          echo "Testing: ${{ steps.find_deb.outputs.deb_file }}"
          ./bin/test-deb-hardlinks.sh "${{ steps.find_deb.outputs.deb_file }}"

      - name: Test result
        if: success()
        run: |
          echo "✓ DEB package successfully installs on separate filesystems"
          echo "✓ No hardlinks regression detected"

      - name: Test failed
        if: failure()
        run: |
          echo "✗ DEB package failed to install on separate filesystems"
          echo "✗ This indicates a hardlinks regression!"
          echo "✗ Review PR #3756 for context on the original fix"
          exit 1
